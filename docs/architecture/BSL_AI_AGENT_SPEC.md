# BSL AI Agent Standard (Specification)

> **Статус:** ✅ В разработке  
> **Версия:** 1.0.0  
> **Дата:** 2025-11-17  
> **Уникальность:** 100% - специализация для BSL уникальна

---

## Обзор

**BSL AI Agent Standard** — формальная спецификация для работы AI агентов с BSL кодом (язык программирования платформы 1С:Предприятие). Определяет интерфейсы, стандарты генерации и ревью BSL кода, требования к пониманию 1C метаданных.

### Ключевые особенности:

1. **Специализация для BSL** — понимание специфики языка 1C
2. **Генерация кода** — стандарты качества для AI-генерированного BSL кода
3. **Code Review** — автоматический ревью BSL кода с 1C-специфичными проверками
4. **Интеграция с метаданными** — понимание объектов метаданных 1C

---

## 1. Интерфейсы AI агентов для 1C

### 1.1 Базовый интерфейс

Все AI агенты, работающие с BSL кодом, должны реализовывать следующий интерфейс:

```python
class BSLAgentInterface:
    """Базовый интерфейс для AI агентов, работающих с BSL."""
    
    async def generate_code(
        self,
        prompt: str,
        context: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        """
        Генерация BSL кода по описанию.
        
        Args:
            prompt: Описание требуемого кода
            context: Контекст (метаданные, существующий код и т.п.)
        
        Returns:
            {
                "code": str,                    # Сгенерированный код
                "explanation": str,              # Объяснение кода
                "quality_score": float,          # Оценка качества (0-1)
                "warnings": List[str],           # Предупреждения
            }
        """
        raise NotImplementedError
    
    async def review_code(
        self,
        code: str,
        context: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        """
        Ревью BSL кода.
        
        Args:
            code: BSL код для ревью
            context: Контекст (модуль, объект метаданных и т.п.)
        
        Returns:
            {
                "issues": List[Dict],            # Найденные проблемы
                "suggestions": List[Dict],        # Предложения по улучшению
                "quality_score": float,          # Оценка качества (0-1)
                "compliance": Dict,              # Соответствие стандартам
            }
        """
        raise NotImplementedError
```

---

## 2. Стандарты генерации BSL кода

### 2.1 Требования к качеству

**Синтаксис:**
- 100% корректный синтаксис BSL
- Соответствие версии платформы 1C (8.2, 8.3.x)
- Корректное использование ключевых слов BSL

**Семантика:**
- Корректное использование объектов метаданных
- Правильная работа с типами данных
- Корректная обработка ошибок (Попытка-Исключение)

**Best Practices:**
- Использование параметров запросов вместо конкатенации строк
- Кэширование метаданных объектов
- Оптимизация запросов к БД
- Избегание N+1 проблем

### 2.2 Формат результата генерации

```python
{
    "code": str,                    # Сгенерированный BSL код
    "explanation": str,             # Объяснение логики кода
    "quality_score": float,         # Оценка качества (0-1)
    "warnings": List[str],          # Предупреждения
    "metadata_used": List[str],     # Использованные объекты метаданных
    "functions": List[str],         # Список функций/процедур в коде
    "queries": List[str],           # SQL-запросы в коде
    "compliance": {
        "syntax": bool,             # Корректность синтаксиса
        "semantics": bool,          # Корректность семантики
        "best_practices": bool,     # Соответствие best practices
    },
}
```

### 2.3 Валидация сгенерированного кода

Сгенерированный код должен проходить валидацию:

1. **Синтаксическая валидация:**
   - Парсинг через BSL парсер (AST или regex-based)
   - Отсутствие синтаксических ошибок

2. **Семантическая валидация:**
   - Проверка использования объектов метаданных
   - Проверка типов данных
   - Проверка обработки ошибок

3. **Best Practices валидация:**
   - Проверка использования параметров запросов
   - Проверка кэширования метаданных
   - Проверка оптимизации запросов

---

## 3. Стандарты ревью BSL кода

### 3.1 Категории проверок

**Security:**
- SQL injection (использование параметров запросов)
- XSS (экранирование вывода)
- Доступ к данным (проверка прав доступа)

**Performance:**
- Оптимизация запросов к БД
- Избегание N+1 проблем
- Кэширование метаданных
- Оптимизация циклов

**Best Practices:**
- Использование ПроверитьТип() вместо Тип()
- Обработка исключений (Попытка-Исключение)
- Документация кода
- Именование переменных и функций

**1C-специфичные:**
- Правильное использование объектов метаданных
- Корректная работа с регистрами
- Правильная работа с формами
- Оптимизация работы с БД

### 3.2 Формат результата ревью

```python
{
    "issues": [
        {
            "severity": str,        # "critical"|"high"|"medium"|"low"
            "category": str,        # "security"|"performance"|"best_practices"|"1c_specific"
            "message": str,         # Описание проблемы
            "line": int,            # Номер строки
            "suggestion": str,      # Предложение по исправлению
        },
        ...
    ],
    "suggestions": [
        {
            "type": str,            # "refactor"|"optimize"|"document"
            "message": str,         # Описание предложения
            "line": int,           # Номер строки
            "code": str,           # Пример улучшенного кода
        },
        ...
    ],
    "quality_score": float,        # Оценка качества (0-1)
    "compliance": {
        "security": bool,          # Соответствие security стандартам
        "performance": bool,        # Соответствие performance стандартам
        "best_practices": bool,     # Соответствие best practices
        "1c_specific": bool,        # Соответствие 1C-специфичным стандартам
    },
    "metrics": {
        "complexity": int,         # Сложность кода
        "loc": int,                # Количество строк
        "functions_count": int,     # Количество функций
        "queries_count": int,      # Количество запросов
    },
}
```

---

## 4. Требования к пониманию 1C метаданных

### 4.1 Объекты метаданных

AI агент должен понимать:

- **Документы** — структура, модули, формы, команды
- **Справочники** — структура, иерархия, модули
- **Регистры** — регистры сведений, накопления, бухгалтерии
- **Общие модули** — серверные/клиентские вызовы
- **Отчеты и обработки** — структура, модули, формы

### 4.2 Использование метаданных в коде

AI агент должен:

- Понимать обращения к метаданным (`Метаданные.Документы.ИмяДокумента`)
- Понимать работу с объектами (`Документы.ИмяДокумента`)
- Понимать работу с регистрами (`РегистрыСведений.ИмяРегистра`)
- Понимать работу с запросами к БД

### 4.3 Контекст для генерации

При генерации кода AI агент должен учитывать:

- Тип объекта метаданных (Документ, Справочник, Регистр)
- Модуль, в котором генерируется код (ObjectModule, ManagerModule, FormModule)
- Существующий код в модуле
- Используемые объекты метаданных

---

## 5. Best Practices для работы с BSL

### 5.1 Производительность

- **Запросы к БД:**
  - Использовать параметры запросов вместо конкатенации строк
  - Избегать запросов в циклах
  - Использовать временные таблицы для сложных запросов

- **Метаданные:**
  - Кэшировать метаданные объектов
  - Использовать `Метаданные.НайтиПоПолномуИмени()` для поиска

- **Циклы:**
  - Избегать вложенных циклов
  - Использовать `Для Каждого` вместо `Для i = 1 По Массив.ВГраница()`

### 5.2 Безопасность

- **SQL Injection:**
  - Всегда использовать параметры запросов
  - Не использовать конкатенацию строк для построения запросов

- **Доступ к данным:**
  - Проверять права доступа перед операциями
  - Использовать `ПроверитьПрава()` для проверки прав

### 5.3 Поддерживаемость

- **Документация:**
  - Комментировать сложную логику
  - Описывать параметры функций
  - Описывать возвращаемые значения

- **Именование:**
  - Использовать понятные имена переменных и функций
  - Следовать соглашениям об именовании 1C

---

## 6. JSON Schema для результатов AI агентов

### 6.1 Схема результата генерации

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://1c-ai-stack.example.com/schemas/bsl-ai-agent/generation-result/v1",
  "title": "BSLCodeGenerationResult",
  "type": "object",
  "required": ["code", "quality_score"],
  "properties": {
    "code": {"type": "string"},
    "explanation": {"type": "string"},
    "quality_score": {"type": "number", "minimum": 0, "maximum": 1},
    "warnings": {"type": "array", "items": {"type": "string"}},
    "metadata_used": {"type": "array", "items": {"type": "string"}},
    "functions": {"type": "array", "items": {"type": "string"}},
    "queries": {"type": "array", "items": {"type": "string"}},
    "compliance": {
      "type": "object",
      "properties": {
        "syntax": {"type": "boolean"},
        "semantics": {"type": "boolean"},
        "best_practices": {"type": "boolean"}
      }
    }
  }
}
```

### 6.2 Схема результата ревью

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://1c-ai-stack.example.com/schemas/bsl-ai-agent/review-result/v1",
  "title": "BSLCodeReviewResult",
  "type": "object",
  "required": ["issues", "quality_score"],
  "properties": {
    "issues": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["severity", "category", "message"],
        "properties": {
          "severity": {"type": "string", "enum": ["critical", "high", "medium", "low"]},
          "category": {"type": "string", "enum": ["security", "performance", "best_practices", "1c_specific"]},
          "message": {"type": "string"},
          "line": {"type": "integer"},
          "suggestion": {"type": "string"}
        }
      }
    },
    "quality_score": {"type": "number", "minimum": 0, "maximum": 1},
    "compliance": {
      "type": "object",
      "properties": {
        "security": {"type": "boolean"},
        "performance": {"type": "boolean"},
        "best_practices": {"type": "boolean"},
        "1c_specific": {"type": "boolean"}
      }
    }
  }
}
```

---

## 7. Интеграция с другими стандартами

### 7.1 BSL Code Graph

- Использование графа для понимания зависимостей
- Анализ влияния изменений через граф
- Рекомендации на основе графа

### 7.2 LLM Provider Abstraction

- Выбор подходящего LLM провайдера для BSL кода
- Специализированные промпты для BSL
- Использование BSL Fine-Tuned моделей

### 7.3 Scenario DSL

- Генерация кода в рамках сценариев
- Ревью кода в рамках сценариев
- Использование графа для рекомендаций

---

## 8. Примеры использования

### 8.1 Генерация кода

```python
from src.ai.agents.developer_agent_secure import DeveloperAgentSecure

agent = DeveloperAgentSecure()
result = await agent.generate_code(
    "Создай функцию для расчета НДС",
    context={
        "module": "ОбщийМодуль.Расчеты",
        "metadata": ["Документы.СчетНаОплату"],
    },
)

print(result["code"])
print(f"Quality: {result['quality_score']}")
```

### 8.2 Ревью кода

```python
from src.ai.agents.code_review.ai_reviewer import AICodeReviewer

reviewer = AICodeReviewer()
result = await reviewer.review_code(
    code,
    context={
        "module": "Документы.ЗаказыПокупателей",
        "module_type": "ObjectModule",
    },
)

for issue in result["issues"]:
    print(f"{issue['severity']}: {issue['message']}")
```

---

## 9. Следующие шаги

1. **Реализация валидаторов** — создание валидаторов для проверки соответствия результатов стандарту
2. **Интеграция с AI агентами** — обновление существующих AI агентов для соответствия стандарту
3. **Документация примеров** — добавление примеров использования AI агентов для BSL

---

**Примечание:** Этот стандарт обеспечивает единообразие работы AI агентов с BSL кодом, делая систему предсказуемой и надежной.

